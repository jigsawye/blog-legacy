<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/component---src-layouts-index-js-df118401f86114d944d5.js" as="script"/><link rel="preload" href="/component---src-templates-post-js-3ece64eb544b4337b005.js" as="script"/><link rel="preload" href="/path---2015-09-25-gitlab-ce-in-docker-ccd7b6f53f8af07109c6.js" as="script"/><link rel="preload" href="/app-990f9b36c22ef8abb728.js" as="script"/><link rel="preload" href="/commons-ac37e82fc4ee97f22c42.js" as="script"/><style data-styled-components="iinwMj PqukP itcpC klcsvg jfwFpV kQwGyp iBxLLb jppxSq gOvnRA bnNivy dVaxDj hVfqKT">
/* sc-component-id: Container-ig9vs6-0 */
.PqukP{max-width:650px;margin:auto;} @media (max-width:730px){.PqukP{max-width:100%;padding:0px 10px;}} @media (max-width:950px){.PqukP{max-width:100%;padding:0px 20px;}}
/* sc-component-id: Logo__LogoWrapper-s1wctbeh-0 */
.itcpC{padding:30px 0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}
/* sc-component-id: Logo__LogoLink-s1wctbeh-1 */
.klcsvg{display:block;width:28px;height:24px;position:relative;}
/* sc-component-id: Nav__NavWrapper-s11p33ll-0 */
.jfwFpV{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:2px 0 0 auto;} .jfwFpV a{border:0;font-size:12px;padding:10px;color:#999;text-transform:uppercase;-webkit-text-decoration:none;text-decoration:none;-webkit-transition:color 0.2s ease;transition:color 0.2s ease;} .jfwFpV a.active{color:#000;} .jfwFpV a:hover{background:none;color:#000;}
/* sc-component-id: Header__HeaderWrapper-p85ae5-0 */
.iinwMj{margin:auto;position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}
/* sc-component-id: Copyright__CopyrightWrapper-s1po10f6-0 */
.hVfqKT{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;vertical-align:top;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding:40px 0;margin:auto;} .hVfqKT p{color:#999999;text-align:center;font-size:12px;} .hVfqKT a{color:#999999;-webkit-text-decoration:none;text-decoration:none;font-size:12px;-webkit-transition:all 0.2s ease;transition:all 0.2s ease;} .hVfqKT a:hover{color:#000;}
/* sc-component-id: Footer__FooterWrapper-s1xnxroi-0 */
.dVaxDj{background:#fafafa;border-top:1px solid #eaeaea;}
/* sc-component-id: sc-global-3887129010 */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); {/*! normalize.css v8.0.0 | MIT License | github.com/necolas/normalize.css */} html{line-height:1.15;-webkit-text-size-adjust:100%;} body{margin:0;} h1{font-size:2em;margin:0.67em 0;} hr{box-sizing:content-box;height:0;overflow:visible;} pre{font-family:monospace,monospace;font-size:1em;} a{background-color:transparent;} abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;} b,strong{font-weight:bolder;} code,kbd,samp{font-family:monospace,monospace;font-size:1em;} small{font-size:80%;} sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;} sub{bottom:-0.25em;} sup{top:-0.5em;} img{border-style:none;} button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;} button,input{overflow:visible;} button,select{text-transform:none;} button,[type='button'],[type='reset'],[type='submit']{-webkit-appearance:button;} button::-moz-focus-inner,[type='button']::-moz-focus-inner,[type='reset']::-moz-focus-inner,[type='submit']::-moz-focus-inner{border-style:none;padding:0;} button:-moz-focusring,[type='button']:-moz-focusring,[type='reset']:-moz-focusring,[type='submit']:-moz-focusring{outline:1px dotted ButtonText;} fieldset{padding:0.35em 0.75em 0.625em;} legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;} progress{vertical-align:baseline;} textarea{overflow:auto;} [type='checkbox'],[type='radio']{box-sizing:border-box;padding:0;} [type='number']::-webkit-inner-spin-button,[type='number']::-webkit-outer-spin-button{height:auto;} [type='search']{-webkit-appearance:textfield;outline-offset:-2px;} [type='search']::-webkit-search-decoration{-webkit-appearance:none;} ::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;} details{display:block;} summary{display:list-item;} template{display:none;} [hidden]{display:none;} .gatsby-highlight{font-size:13px;background-color:#fff;color:#000;border-width:1px;border-style:solid;border-color:rgb(234,234,234);margin:40px 0px;padding:20px;overflow:auto;} .gatsby-highlight code[class*='language-'],.gatsby-highlight pre[class*='language-'],.gatsby-highlight pre.prism-code{background-color:transparent;margin:0;padding:0;overflow:initial;float:left;min-width:100%;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;} .gatsby-highlight + .gatsby-highlight{margintop:20;} .gatsby-highlight-code-line{backgroundcolor:#ddd;display:block;margin:-0.125rem calc(-1rem - 15px);padding:0.125rem calc(1rem + 15px);} .token.attr-name{color:#d73a49;} .token.comment,.token.block-comment,.token.prolog,.token.doctype,.token.cdata{color:#6a737d;} .token.property,.token.number,.token.function-name,.token.constant,.token.symbol,.token.deleted{color:#005cc5;} .token.boolean{color:#005cc5;} .token.string{color:#032f62;} .token.punctuation{color:#24292e;} .token.selector,.token.char,.token.builtin,.token.inserted{color:#22863a;} .token.function{color:#005cc5;} .token.operator,.token.entity,.token.url,.token.variable{color:#005cc5;} .token.attr-value{color:#032f62;} .token.keyword{color:#d73a49;} .token.atrule,.token.class-name{color:#6f42c1;} .token.important{fontweight:400;} .token.bold{fontweight:700;} .token.italic{fontstyle:italic;} .token.entity{cursor:help;} .namespace{opacity:0.7;} body{font-family:'SF Pro TC','SF Pro Text','PingFang TC','Helvetica Neue','Helvetica','Arial','Microsoft JhengHei',wf_SegoeUI,'Segoe UI',Segoe,'Segoe WP',Tahoma,Verdana,Ubuntu,'Bitstream Vera Sans','DejaVu Sans',Tahoma,微軟正黑體,'LiHei Pro','WenQuanYi Micro Hei','Droid Sans Fallback','AR PL UMing TW',Roboto,'Helvetica Neue','Hiragino Maru Gothic ProN',メイリオ,'ヒラギノ丸ゴ ProN W4',Meiryo,'Droid Sans',sans-serif;text-rendering:optimizeLegibility;} ::selection{background-color:#79ffe1;color:#000;} code,pre{font-family:Menlo,Monaco,Consolas,'Courier New','Roboto Mono',monospace;}
/* sc-component-id: ArticleTitleSection__Wrapper-s8eqskn-0 */
.kQwGyp{width:100%;padding-bottom:10px;margin-top:35px;margin-bottom:80px;border-bottom:1px solid rgb(234,234,234);}
/* sc-component-id: ArticleTitleSection__Title-s8eqskn-1 */
.iBxLLb{color:rgb(0,0,0);font-weight:400;font-size:28px;max-width:650px;text-align:center;padding-left:20px;padding-right:20px;line-height:42px;margin:0px auto;}
/* sc-component-id: ArticleTitleSection__Date-s8eqskn-2 */
.jppxSq{color:rgb(153,153,153);font-size:12px;text-align:center;margin:20px 0px 40px;}
/* sc-component-id: ArticleContent-s1ah6ipv-0 */
.gOvnRA{font-weight:400;font-size:14px;line-height:24px;margin:30px 0 15px;} .gOvnRA p{margin-bottom:20px;} .gOvnRA a{color:rgb(6,125,247);font-size:inherit;-webkit-text-decoration:none;text-decoration:none;} .gOvnRA h1,.gOvnRA h2,.gOvnRA h3,.gOvnRA h4,.gOvnRA h5,.gOvnRA h6{font-weight:bold;font-size:18px;margin-top:40px;} .gOvnRA strong{font-weight:600;} .gOvnRA blockquote{border-left:5px solid;margin:0;padding-left:10px;} .gOvnRA ul{list-style-type:none;margin-left:15px;padding:0px;} .gOvnRA ul li{font-size:14px;line-height:24px;margin-bottom:10px;} .gOvnRA ul li ul{margin-top:10px;} .gOvnRA ul li:before{content:'-';display:inline-block;color:rgb(153,153,153);position:absolute;margin-left:-15px;} .gOvnRA img{width:100%;display:block;text-align:center;margin:40px 0px;} .gOvnRA code[class*='language-text'],.gOvnRA code:not([class*='language-']){color:rgb(189,16,224);font-size:0.9em;white-space:pre-wrap;} .gOvnRA code[class*='language-text']:before,.gOvnRA code:not([class*='language-']):before{content:'`';} .gOvnRA code[class*='language-text']:after,.gOvnRA code:not([class*='language-']):after{content:'`';}
/* sc-component-id: Disqus__CommentWrapper-s1rk6p9u-0 */
.bnNivy{margin:40px 0 20px;}</style><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><script>
            
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-57230871-3',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(!(navigator.doNotTrack == "1" || window.doNotTrack == "1")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-57230871-3', 'auto');
      ga('set', 'anonymizeIp', 1);}
      </script><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><title data-react-helmet="true">使用 Docker 建置 Gitlab CE 的 Source Control 及 CI 環境 – JIGSAWYE</title><link data-react-helmet="true" rel="icon" href="/static/favicon.4877df40.png"/><link data-react-helmet="true" rel="search" type="application/opensearchdescription+xml" href="/rss.xml" title="JIGSAWYE"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" property="og:site_name" content="JIGSAWYE"/><meta data-react-helmet="true" property="og:image" content="https://avatars1.githubusercontent.com/u/8567270?v=3&amp;s=300"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="description"/><meta data-react-helmet="true" property="og:url" content="https://jigsawye.com/2015/09/25/gitlab-ce-in-docker/"/><meta data-react-helmet="true" property="og:title" content="使用 Docker 建置 Gitlab CE 的 Source Control 及 CI 環境 – JIGSAWYE"/><meta data-react-helmet="true" property="og:description"/><meta data-react-helmet="true" name="twitter:title" content="使用 Docker 建置 Gitlab CE 的 Source Control 及 CI 環境 – JIGSAWYE"/><meta data-react-helmet="true" name="twitter:description"/><style id="gatsby-inlined-css"></style></head><body><div id="___gatsby"><article class="Header__HeaderWrapper-p85ae5-0 iinwMj Container-ig9vs6-0 PqukP"><aside class="Logo__LogoWrapper-s1wctbeh-0 itcpC"><a class="Logo__LogoLink-s1wctbeh-1 klcsvg" href="/"><img src="/static/favicon.4877df40.png" height="28px" width="28px" alt="Logo"/></a></aside><div class="Nav__NavWrapper-s11p33ll-0 jfwFpV"><a aria-current="false" href="/">HOME</a><a aria-current="false" href="/archives">ARCHIVE</a><a aria-current="false" href="/about">ABOUT</a><a href="/rss.xml" target="_blank" rel="noopener noreferrer">RSS</a></div></article><aside class="ArticleTitleSection__Wrapper-s8eqskn-0 kQwGyp"><h1 class="ArticleTitleSection__Title-s8eqskn-1 iBxLLb">使用 Docker 建置 Gitlab CE 的 Source Control 及 CI 環境</h1><div class="ArticleTitleSection__Date-s8eqskn-2 jppxSq">2015 年 9 月 25 日（3 年前）</div></aside><article class="Container-ig9vs6-0 PqukP"><div class="ArticleContent-s1ah6ipv-0 gOvnRA"><blockquote>
<p>更新於 2017/1/10：此文年久失修，可能有許多情形與現實不符，請斟酌參考。</p>
</blockquote>
<blockquote>
<p>本文建議了解 unix-like 基礎指令及 Docker 基本操作者閱讀。</p>
</blockquote>
<p>這幾天在我們的 imaclab 試著建置 CI 環境，順便就學了 Docker，發現 Docker 這東西真的非常方便，直接把環境都放進 container 裡，也不怕把環境搞爛。對環境建置的苦手真的是一番福音，網路上也很多關於 Docker 的文章，在這邊也不贅述了。
原本在架設的時候想使用 Gitlab + Jenkins，不過因專案的需求沒有需要 Jenkins 這麼開放客製化的 CI 工具（其實是我覺得很囉唆一堆東西要設定），剛好 Gitlab 也有提供 CI，需求上也符合，所以就決定使用 Gitlab + Gitlab CI。</p>
<!-- more -->
<h3 id="gitlab"><a href="#gitlab" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Gitlab</h3>
<p>以自行架設私有的版本控制環境來說，Gitlab 肯定是首選（因為我不知道還有哪些版控可以自己架），很久以前曾經自己在 ubuntu 上用官方提供的一鍵安裝包裝過一次，用過這種懶人包的都知道，裝的時候完全不知道發生什麼事，尤其當時還很菜。那時是成功架起來沒錯，不過完全不知道發生了什麼事。</p>
<h6 id="環境"><a href="#%E7%92%B0%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>環境</h6>
<p>我是直接用了學長架的 OpenStack 叢集開一個 instance 當建置環境，基本上要照這份筆記安裝 Gitlab CE，應該只要隨便一個有裝 Docker 的 unix-like 系統都可以。</p>
<p><img src="https://i.imgur.com/sCxpbLf.png" alt="Imgur"></p>
<h6 id="安裝"><a href="#%E5%AE%89%E8%A3%9D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安裝</h6>
<p>透過 Docker 安裝 Gitlab CE 很簡單，只要在 <a href="https://hub.docker.com">Docker Hub</a> 上找 gitlab 就可以找到很多的 images，我選了 star 最多的 <a href="https://hub.docker.com/r/sameersbn/gitlab/">sameersbn/gitlab</a> ，基本上只要照 image 的文件做就可以了。</p>
<p>首先將 <code class="language-text">sameersbn/gitlab</code> 的 image pull 下來。</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash">docker pull sameersbn/gitlab:8.0.2</code></pre>
      </div>
<p>接著有兩種方式可以啟動 Gitlab：最簡單的是使用 <code class="language-text">docker-compose</code>，透過設定檔啟動。另外就是手動執行 <code class="language-text">docker run</code> 指令將 gitlab 所需的 service 逐一啟動。這邊我選擇後者，因為我沒裝 docker-compose，未來有安裝在補充這部分的使用方式。</p>
<p>除了 Gitlab 本身，他還需要額外啟用 <code class="language-text">PostgreSQL</code> 及 <code class="language-text">Redis</code> 的 servcie，基本上只要按照文件啟動 container 就可以了：</p>
<p>啟動 PostgreSQL container：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash">docker run --name gitlab-postgresql -d \
    --env <span class="token string">'DB_NAME=gitlabhq_production'</span> \
    --env <span class="token string">'DB_USER=gitlab'</span> --env <span class="token string">'DB_PASS=password'</span> \
    --volume /srv/docker/gitlab/postgresql:/var/lib/postgresql \
    sameersbn/postgresql:9.4-3</code></pre>
      </div>
<p>啟動 Redis container：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash">docker run --name gitlab-redis -d \
    --volume /srv/docker/gitlab/redis:/var/lib/redis \
    sameersbn/redis:latest</code></pre>
      </div>
<p>最後啟動 Gitlab container。這邊要注意我除了照原文件之外，還額外加上 <code class="language-text">GITLAB_HOST</code>，因為我的建置環境不在本機上，所以要加上該環境的 ip，否則 user 的大頭貼會是死圖。另外指令中的 <code class="language-text">long-and-random-alpha-numeric-string</code> 請替換成一組隨機字串，可以使用 <code class="language-text">pwgen -Bsv1 64</code> 來產生：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash">docker run --name gitlab -d \
    --link gitlab-postgresql:postgresql --link gitlab-redis:redisio \
    --publish 10022:22 --publish 10080:80 \
    --env <span class="token string">'GITLAB_HOST=your-gitlab-ip'</span> \
    --env <span class="token string">'GITLAB_PORT=10080'</span> --env <span class="token string">'GITLAB_SSH_PORT=10022'</span> \
    --env <span class="token string">'GITLAB_SECRETS_DB_KEY_BASE=long-and-random-alpha-numeric-string'</span> \
    --volume /srv/docker/gitlab/gitlab:/home/git/data \
    sameersbn/gitlab:8.0.2</code></pre>
      </div>
<h6 id="完成！"><a href="#%E5%AE%8C%E6%88%90%EF%BC%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>完成！</h6>
<p><img src="https://i.imgur.com/nzIAG0F.png" alt="Imgur"></p>
<p>打開瀏覽器瀏覽 <code class="language-text">http://your-gitlab-ip:10080</code>，就可以看到 Gitlab 架設好了，輸入預設的帳號密碼就可以直接登入：</p>
<ul>
<li>username: <strong>root</strong></li>
<li>password: <strong>5iveL!fe</strong></li>
</ul>
<h3 id="gitlab-ci"><a href="#gitlab-ci" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Gitlab CI</h3>
<p>這次安裝的時候原本第一天裝 Gitlab CE 7.14.3，Gitlab CI 還要另外做安裝，後來更新到 8.0.0 的時候 Gitlab 把 CI 整合進了 Gitlab CE 裡，所以只需要裝 Gitlab CE 就包含了 CI 的功能了！兩個願望一次滿足！</p>
<p>以下以簡單的 Node.js project 為例，做一次完整的 CI Flow：</p>
<h6 id="建立-repository"><a href="#%E5%BB%BA%E7%AB%8B-repository" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>建立 repository</h6>
<p>首先在 Gitlab 上建立一個 <code class="language-text">ci-flow</code> 的 repository：</p>
<p><img src="https://i.imgur.com/KSkMits.png" alt="Imgur"></p>
<p>接著點選 CI 選項，點選 <strong>Add project to CI</strong> 將剛剛建立的 <code class="language-text">ci-flow</code> 加入至 CI 中：</p>
<p><img src="https://i.imgur.com/wvhHuHd.png" alt="Imgur"></p>
<p>點選 runner 分頁，記下 url 及 token：</p>
<p><img src="https://i.imgur.com/i1kpNnD.png" alt="Imgur"></p>
<h6 id="gitlab-runner"><a href="#gitlab-runner" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>gitlab-runner</h6>
<p>什麼是 <code class="language-text">gitlab-runner</code> 呢？簡單來說就是透過這個 runner 去執行 CI 所要執行的工作。例如我以 docker 做測試環境，runner 會建立預先設定好 image 的 container，CI 被觸發時會自動 start 該 container，並把 repository pull 至 container 內，接著執行指定的動作。在這部分我們要安裝及設定 <code class="language-text">gitlab-runner</code>，並註冊讓它執行。</p>
<p>透過 Docker 安裝 gitlab-runner，參考<a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/install/docker.md">官方文件</a>：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash">docker run -d --name gitlab-runner --restart always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /srv/gitlab-runner/config:/etc/gitlab-runner \
  gitlab/gitlab-runner:latest</code></pre>
      </div>
<p>執行 gitlab-runner 進行註冊，這邊的 url 及 token 就是剛剛 runner 分頁對應的資料。其餘部分根據需求做選擇，像我不需要 DB 的 Service 所以一律 enter 略過：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash">docker <span class="token function">exec</span> -it gitlab-runner gitlab-runner register

Please enter the gitlab-ci coordinator URL <span class="token punctuation">(</span>e.g. https://gitlab.com/ci <span class="token punctuation">)</span>
https://your-gitlab-ip:10080/ci

Please enter the gitlab-ci token <span class="token keyword">for</span> this runner
your-gitlab-ci-token

Please enter the gitlab-ci description <span class="token keyword">for</span> this runner
<span class="token punctuation">[</span>86598ea6394b<span class="token punctuation">]</span>: node-4.1.1

INFO<span class="token punctuation">[</span>0034<span class="token punctuation">]</span> 08cc0e60 Registering runner<span class="token punctuation">..</span>. succeeded
Please enter the executor: docker, docker-ssh, ssh, shell, parallels:
<span class="token punctuation">[</span>shell<span class="token punctuation">]</span>: docker

Please enter the Docker image <span class="token punctuation">(</span>eg. ruby:2.1<span class="token punctuation">)</span>:
node:4.1.1

If you want to <span class="token function">enable</span> mysql please enter version <span class="token punctuation">(</span>X.Y<span class="token punctuation">)</span> or enter latest?

If you want to <span class="token function">enable</span> postgres please enter version <span class="token punctuation">(</span>X.Y<span class="token punctuation">)</span> or enter latest?

If you want to <span class="token function">enable</span> redis please enter version <span class="token punctuation">(</span>X.Y<span class="token punctuation">)</span> or enter latest?

If you want to <span class="token function">enable</span> mongo please enter version <span class="token punctuation">(</span>X.Y<span class="token punctuation">)</span> or enter latest?

INFO<span class="token punctuation">[</span>0045<span class="token punctuation">]</span> Runner registered successfully. Feel <span class="token function">free</span> to start it, but <span class="token keyword">if</span> it's running already the config should be automatically reloaded<span class="token operator">!</span></code></pre>
      </div>
<p>現在前往 CI 的 runner 分頁應該就會看到 node-4.1.1 並且是 active 的。</p>
<p><img src="https://i.imgur.com/ku19Gss.png" alt="Imgur"></p>
<blockquote>
<p>注意，這邊我們要編輯 node-4.1.1 這個 runner，並增加名為 node-4.1.1 的 tag 讓 CI 能夠啟動對應的 runner。</p>
</blockquote>
<p><img src="https://i.imgur.com/N2dSh45.png" alt="Imgur"></p>
<h6 id="建立-project"><a href="#%E5%BB%BA%E7%AB%8B-project" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>建立 project</h6>
<p>建立一個 project，並使用 <code class="language-text">npm init</code>（enter 到底就可以了）產生 <code class="language-text">package.json</code>，接著安裝 node.js 的測試工具 <code class="language-text">mocha</code>：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> ci-flow
<span class="token function">cd</span> ci-flow
<span class="token function">npm</span> init
<span class="token function">npm</span> <span class="token function">install</span> mocha --save-dev</code></pre>
      </div>
<p>接著建立檔案 <code class="language-text">test/test.js</code> 並撰寫簡單的測試程式：</p>
<div class="gatsby-highlight" data-language="js test/test.js">
      <pre class="language-js test/test.js"><code class="language-js test/test.js">var assert = require(&#39;assert&#39;);

describe(&#39;Array&#39;, function() {
  describe(&#39;#indexOf()&#39;, function() {
    it(&#39;should return -1 when the value is not present&#39;, function() {
      assert.equal(-1, [1, 2, 3].indexOf(5));
      assert.equal(-1, [1, 2, 3].indexOf(0));
    });
  });
});</code></pre>
      </div>
<p>寫完測試當然要在 local 測試一下，直接執行 project 中安裝的 <code class="language-text">./node_modules/mocha/bin/mocha</code>：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash">$ ./node_modules/mocha/bin/mocha

  Array
    <span class="token comment">#indexOf()</span>
      ✓ should <span class="token keyword">return</span> -1 when the value is not present


  1 passing <span class="token punctuation">(</span>9ms<span class="token punctuation">)</span></code></pre>
      </div>
<p>測試成功！接著我們來設定 CI 所要使用的 image 及執行的 script。</p>
<h6 id="gitlab-ciyml"><a href="#gitlab-ciyml" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>.gitlab-ci.yml</h6>
<p>重點來了，我們要在專案的根目錄建立 <code class="language-text">.gitlab-ci.yml</code> 的檔案，用於決定 Gitlab CI 要如何對專案 build、test、deploy...等等，類似於 Travis CI 的 <code class="language-text">.travis.yml</code>。詳細的可用選項可以參考<a href="http://doc.gitlab.com/ci/yaml/README.html">官方文件</a>，這邊以我的例子做解說：
<code class="language-text">before_script</code> 是執行 job 前會執行的 script，我在這邊設定安裝 node 的 dependencies，也就是 <code class="language-text">mocha</code> 這個 test tool。<code class="language-text">stages</code> 為設定有幾種工作階段，一般可能就會有 <code class="language-text">build</code>、<code class="language-text">test</code>、<code class="language-text">deploy</code>，並按照順序逐一執行對應的 job，我這邊單獨以 <code class="language-text">test</code> 做例子。接著制定第一個 job，對應的就是 <code class="language-text">test</code> 這個 stage，在 <code class="language-text">script</code> 增加執行 project 內的 <code class="language-text">mocha</code> 做測試，並指在 <code class="language-text">master</code> 這個 branch，最後加上一個 <code class="language-text">node-4.1.1</code> 的 tag 去啟動對應 tag 為 <code class="language-text">node-4.1.1</code> 的 <code class="language-text">gitlab-runner</code>，因為一般在測試時可能會針對多個不同版本的環境做測試，所以會使用 tag 這個功能來做設定。</p>
<div class="gatsby-highlight" data-language="ruby .gitlab-ci.yml">
      <pre class="language-ruby .gitlab-ci.yml"><code class="language-ruby .gitlab-ci.yml">before_script:
  - npm install
stages:
  - test
job1:
  stage: test
  script:
    - ./node_modules/mocha/bin/mocha
  only:
    - master
  tags:
    - node-4.1.1</code></pre>
      </div>
<p>在版本控制上並不希望 <code class="language-text">node_modules</code> 放入版本控制中，所以增加 <code class="language-text">.gitignore</code> 檔案並排除該目錄：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash"><span class="token function">touch</span> .gitignore
<span class="token keyword">echo</span> node_modules <span class="token operator">></span> .gitignore</code></pre>
      </div>
<p>加入版本控制：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash"><span class="token function">git</span> init
<span class="token function">git</span> add <span class="token keyword">.</span>
<span class="token function">git</span> commit -m <span class="token string">'Test gitlab-ci with &lt;3'</span></code></pre>
      </div>
<p>Push 至 Repository：</p>
<div class="gatsby-highlight" data-language="bash">
      <pre class="language-bash"><code class="language-bash"><span class="token function">git</span> remote add origin your-project-repository
<span class="token function">git</span> push -u origin master</code></pre>
      </div>
<p>最後等待 CI 自動執行測試！</p>
<h6 id="執行結果"><a href="#%E5%9F%B7%E8%A1%8C%E7%B5%90%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>執行結果</h6>
<p>Push 至 Repository 後可以在 CI 的 Dashboard 看見剛剛的 commit 已經 pending 了：</p>
<p><img src="https://i.imgur.com/P8qn1rQ.png" alt="Imgur"></p>
<p>點進去後可以看到目前須執行的所有 job，根據你的 <code class="language-text">.gitlab-ci.yml</code> 而定，一般來說會在多個環境測試，並包含 deploy 等多種不同的 job：</p>
<p><img src="https://i.imgur.com/HElBwtE.png" alt="Imgur"></p>
<p>等待一段時間後就成功就會顯示 Success：</p>
<p><img src="https://i.imgur.com/rLqbgsW.png" alt="Imgur"></p>
<p>你也可以點進 build 中看執行的結果：</p>
<p><img src="https://i.imgur.com/h3B39rH.png" alt="Imgur"></p>
<h6 id="slack-integration"><a href="#slack-integration" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Slack Integration</h6>
<p>Gitlab CI 也有提供 Slack 的整合，提供即時的 CI 狀態，只要填入 Webhook 即可：</p>
<p><img src="https://i.imgur.com/eh79dAw.png" alt="Imgur"></p>
<h3 id="總結"><a href="#%E7%B8%BD%E7%B5%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>總結</h3>
<p>搞了三天左右都在學 Docker 跟弄這些環境，在精疲力乏與中秋烤肉之際順便記錄一下過程。
文中一些細節可以在根據需求做修改，像是在 test 的 docker image 就可以把 <code class="language-text">mocha</code> 裝進去，不用在 project 中額外安裝。Gitlab 的 CI 雖然不像 Jenkins CI 那麼容易的客製化，但是基本的功能也能滿足一些需求。當然 Gitlab CI 的功能我可能也沒完全摸透，可能有更強大的功能也說不定。</p>
<p>另外未來還會串上 CD，另外加開一台 staging 的 instance 來 deploy，之後若串起來有空再寫下一篇分享。</p></div></article><article class="Container-ig9vs6-0 PqukP"><div class="Disqus__CommentWrapper-s1rk6p9u-0 bnNivy"><div id="disqus_thread"></div></div></article><footer class="Footer__FooterWrapper-s1xnxroi-0 dVaxDj"><div class="Copyright__CopyrightWrapper-s1po10f6-0 hVfqKT"><p>Copyright © <!-- -->2018<!-- --> <a href="https://jigsawye.com">Evan Ye</a>, powered by<!-- --> <a href="https://www.gatsbyjs.org/" rel="noopener noreferrer" target="_blank">Gatsby</a>. All rights reserved.</p></div></footer></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-990f9b36c22ef8abb728.js","195351340454287":"component---src-templates-post-js-3ece64eb544b4337b005.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","263791100135453":"component---src-pages-about-js-c1d8607b0fd7c315391f.js","106735565224735":"component---src-pages-archives-js-4c40eea380c70777ce23.js","35783957827783":"component---src-pages-index-js-5b02225ffb2dd529aec1.js","60335399758886":"path----d960a0fdb0a2be33ebb2.js","252616794223546":"path---2015-06-22-using-pjax-with-laravel-5-b5432410733c99522dcb.js","272257299430140":"path---2015-07-23-use-route-model-binding-in-laravel-5d8cbb824683acb10d6a.js","215612892651089":"path---2015-10-07-jsdc-2015-day-2-6e84caaada7256c7bf39.js","123347437307850":"path---2015-10-10-install-docker-on-mac-via-homebrew-767d5f5392f4b03e5ae2.js","88695705345427":"path---2015-10-05-jsdc-2015-day-1-2e52e129ad71afab5f06.js","172680683855257":"path---2015-11-23-enable-emmet-for-jsx-in-sublime-6bb423dea5574ea250aa.js","181314048770231":"path---2015-10-06-javascript-object-assign-ed53e15d0f978de05092.js","104406283745572":"path---2015-12-06-ptt-in-osx-terminal-3f577325cc23976f6d43.js","251941979200700":"path---2015-11-29-instruction-with-redux-1b4d18259d4017897a53.js","210549781037358":"path---2015-11-30-running-react-native-on-device-30e7fa9253ff395b92b7.js","11451596932533":"path---2015-12-06-prevent-ssh-disconnect-c06630a2ace06a36190f.js","232519048065869":"path---2016-04-18-understanding-javascript-async-await-9312507b1053d012b770.js","10425247419302":"path---2016-06-21-install-fish-shell-on-os-x-455e48cf4e4b0a51d0a0.js","148839667420256":"path---2017-08-30-vuex-module-namespacing-b7f77fcb17cde74c7279.js","113320626823893":"path---2015-09-25-gitlab-ce-in-docker-ccd7b6f53f8af07109c6.js","213265620909541":"path---2015-12-22-push-notification-to-user-in-laravel-5-e550a0dc920e4d7dfcb3.js","161789320775696":"path---2017-09-04-make-good-use-of-lodash-029f7939f6b89fe697c6.js","180747060961185":"path---2016-02-01-setup-laravel-development-environment-with-homebrew-1b8e5a8672642fcaaaed.js","248055528273643":"path---2018-07-22-getting-started-apollo-server-64f5079ccb6a1260e478.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","273950069227526":"path---about-813eccab5cdf494fdb52.js","66145460603085":"path---archives-3e7899979d7df1010276.js","142629428675168":"path---index-4696ccc8a955dafcef6a.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-df118401f86114d944d5.js"}/*]]>*/</script><script>/*<![CDATA[*/["/commons-ac37e82fc4ee97f22c42.js","/app-990f9b36c22ef8abb728.js","/path---2015-09-25-gitlab-ce-in-docker-ccd7b6f53f8af07109c6.js","/component---src-templates-post-js-3ece64eb544b4337b005.js","/component---src-layouts-index-js-df118401f86114d944d5.js"].forEach(function(s){document.write('<script src="'+s+'" defer></'+'script>')})/*]]>*/</script></body></html>